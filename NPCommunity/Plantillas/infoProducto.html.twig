<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Producto</title>
		<script type="text/javascript" src="{{ asset('js/busqueda.js') }}"></script>
		<script type="text/javascript" src="{{ asset('js/comprarProducto.js') }}"></script>
		{# Css #}
		<link
		rel="stylesheet" href="{{ asset('css/estilo.css') }}">
		{# Alertas #}
		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
		{# bootstrap #}
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
		<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
		<title>Mensajes</title>
	</head>
	<body>
		{% include 'barraSuperior.html.twig' %}
		<div class="container-fluid  px-5">
			<div id="contenido" class="row">
				<div class="col">
					<div class="row">
						<div class="col-12 col-lg-4">
							<img style="border-radius:100px;" onclick="volver()" width="40px" height="40px" src="{{asset('fotos/flecha.png')}}" alt="">
							<small id="volverDonde" class="text-body-secondary">Volver a la página principal</small>
						</div>
						<div class="col-12 col-lg-8">
							<h1>
								Producto de @{{ producto.idUsuario.nomUsuario }}
								<img style="border-radius:100px;" width="80px" height="80px" src="{{asset('fotos/' ~ producto.idUsuario.getFotoPerfil())}}" alt="">
							</h1>
						</div>
					</div>
					<div class="row">
						<div class="col-12 col-lg-5" style="height: 100%;">
							<div class="row">
								<div class="col-12">
									<div class="row text-center">
										<h4>{{ producto.nombre }}</h4>
									</div>

									<div class="card mx-auto" style="width: 16rem;">
										<img src="{{asset('fotos/' ~ producto.foto)}}" class="card-img-top">
										<div class="card-body">
											<p class="card-text">{{ producto.descripcion }}</p>
											<span id="precio" style="font-size:30px" class="d-flex justify-content-center align-items-center">{{ producto.precio }}€</span>
										</div>
									</div>
									<div class="row mt-1">
										<div class="col d-flex justify-content-center align-items-center">
											{% if error != 1 %}
												{% if app.user != producto.idUsuario %}
													<button type="button" class="btn btn-success" onclick="comprarProducto()">Comprar</button>
												{% else %}
													<button type="button" class="btn btn-secondary" onclick="cambiarPrecio()">Cambiar precio</button>
												{% endif %}
											{% endif %}
										</div>
									</div>
								</div>
							</div>
						</div>
						{# ////////////// #}
						<div class="col-12 col-lg-7 mt-2 mt-lg-0" id="contenidoChats">
							{% if error != 1 %}
								<input id="comprador" value="{{app.user.nomUsuario}}" hidden>
							{% endif %}
							<input id="propietario" value="{{producto.idUsuario.nomUsuario}}" hidden>
							<input id="idProducto" value="{{producto.id}}" hidden>

							{% if conversacion is defined %}
								{# si la conversacion ya esta empezada y el usuario es comprador#}
								<div class="row justify-content-center text-center">
									<h4 id="titulo">Mensajes</h4>
								</div>
								<div class="row mt-2 py-1" id="divScroll" style="height: 550px; overflow-y: auto; border:black dotted 1px;border-radius:10px">
									<div class="col" id="columnaConver">
										{% for mensaje in conversacion %}
											<div class="row mb-2">
												{% if mensaje.idEmisor == producto.idUsuario %}
													<div class="col-1">
														<img style="border-radius: 100px;" width="40px" height="40px" src="{{asset('fotos/' ~ producto.idUsuario.getFotoPerfil())}}" alt="">
													</div>
													<div class="col-7 offset-1 offset-md-0 offset-lg-1 offset-xl-0" style="border: black 1px dashed;border-radius: 12px ;">
														{{ mensaje.contenido }}
													</div>
												{% else %}
													<div class="col-7 offset-3 offset-md-4 offset-lg-3 offset-xl-4" style="border: black 1px dashed;border-radius:12px ;">
														{{ mensaje.contenido }}
													</div>
													<div class="col-1">
														<img style="border-radius: 100px;" width="40px" height="40px" src="{{asset('fotos/' ~ app.user.getFotoPerfil())}}" alt="">
													</div>
												{% endif %}
											</div>
										{% endfor %}
									</div>
								</div>
								<div id="inputEscribir" class="row mt-1">
									<div class="col-10"><input id="mensaje" placeholder="Escribe tu mensaje aquí" class="form-control"></div>

									<div class="col-2">
										<button class="btn btn-primary" onclick="enviarMensajeComoComprador()">Enviar</button>
									</div>
								</div>

							{% elseif todasConver is defined and app.user == producto.idUsuario %}
								{# si la conversacion ya esta empezada y el usuario es propietario#}
								<div class="row justify-content-center text-center">
									<h4 id="titulo">Mensajes</h4>
								</div>
								<div class="row mt-2 p-1" style="height:550px; overflow:auto;border:black dotted 1px;border-radius:10px">
									<div class="col-12">
										<div class="row justify-content-center text-center">
											{% for conver in todasConver %}
												<div class="card mb-3" style="max-width: 550px;">
													<div class="row g-0">
														<div class="col-3 offset-2 d-flex align-items-center">
															<img src="{{asset('fotos/' ~ conver.idUsuario1.getFotoPerfil())}}" width="120px" height="120px" class="img-fluid rounded-circle" alt="...">
														</div>
														<div class="col-6">
															<div class="card-body">
																<h5 class="card-title">{{conver.idUsuario1.nomUsuario}}</h5>
																<button class="btn btn-primary" id="{{conver.id}}" onclick="mostrarChatProd(event)">Escribir</button>
															</div>
														</div>
													</div>
												</div>
											{% endfor %}
										</div>
									</div>
								</div>
							{% elseif app.user == producto.idUsuario %}
								{# si no hayconversaciones y el usuario es propietario#}
								<div class="row justify-content-center text-center">
									<h4 id="titulo">Mensajes</h4>
								</div>
								<div class="row mt-2" id="divScroll" style="height: 550px; overflow-y: auto;border:black dotted 1px;border-radius:10px">

									<div class="row justify-content-center text-center align-items-center" style="font-style:italic">
										Espera a que algún usuario este interesado
									</div>
								</div>
							{% elseif app.user != producto.idUsuario %}
								{# si la conversacion no esta empezada y el usuario es comprador#}
								{% if error != 1 %}
									<input id="comprador" value="{{app.user.nomUsuario}}" hidden>
								{% endif %}
								<input id="propietario" value="{{producto.idUsuario.nomUsuario}}" hidden>
								<input id="idProducto" value="{{producto.id}}" hidden>

								<div class="row justify-content-center text-center">
									<h4 id="titulo">Mensajes</h4>
								</div>

								<div class="row mt-2" id="divScroll" style="height: 550px; overflow-y: auto;border:black dotted 1px;border-radius:10px">
									<div class="row justify-content-center text-center align-items-center" style="font-style:italic">
										{% if error != 1 %}
											Escribe a @{{ producto.idUsuario.nomUsuario }}
											para llegar a un acuerdo
										{% else %}
											<p>Para poder comprar el producto tienes que
												<a href="{{ path('login') }}">iniciar sesión</a>
											</p>
										{% endif %}
									</div>
								</div>
								{% if error != 1 %}
									<div id="inputEscribir" class="row mt-1">
										<div class="col-10"><input id="mensaje" placeholder="Escribe tu mensaje aquí" class="form-control"></div>

										<div class="col-2">
											<button class="btn btn-primary" onclick="enviarMensajeComoComprador()">Enviar</button>
										</div>
									</div>
								{% endif %}
							{% endif %}
						</div>

					</div>

				</div>
			</div>
		</div>
	</body>
</html>
